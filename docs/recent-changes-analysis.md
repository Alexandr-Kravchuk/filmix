# Аналіз останніх змін репозиторію

Огляд підготовлено за останні 4 коміти в `main` гілці:

1. `21f8929` — **Improve Xbox safe mode memory behavior and override support**
2. `8edeffe` — **Add Xbox safe mode and disable heavy background tasks**
3. `6096322` — **Replace header dropdown with direct action buttons**
4. `ce9dd37` — **Add minimal quality mode for low-power devices**

## Що змінилось функціонально

### 1) Режими відтворення: standard / minimal / Xbox safe

- Додано/розширено логіку «легкого» режиму для слабких пристроїв: у minimal mode плеєр працює з найнижчою якістю та без HD-upgrade.
- Для Xbox Edge safe mode вмикається автоматично.
- Додано ручне примусове ввімкнення safe mode через query-параметри URL: `?xbox=1` або `?safe_xbox=1`.

**Практичний ефект:** нижче споживання CPU/RAM і стабільніший старт відео на консолях та слабких браузерах.

### 2) Вимкнення «важких» фоновых задач у safe mode

У safe mode вимикаються фонові оптимізації, що можуть навантажувати пристрій:

- warmup ffmpeg;
- prefetch наступного епізоду;
- batch-праймінг джерел для вікна епізодів;
- output cache у браузерному Cache API.

**Практичний ефект:** менше фонової активності, менше ризику підвисань на Xbox/low-power девайсах.

### 3) Поліпшення керування пам’яттю ffmpeg.wasm

- У `remuxEnglishTrack(...)` додано опцію `releaseAfter`.
- Для Xbox safe mode ця опція вмикається через чергу задач.
- Після завершення підготовки епізоду ffmpeg-інстанс примусово скидається (`terminate()` + очищення стану).

**Практичний ефект:** зниження довгоживучого memory footprint, менша імовірність деградації після кількох епізодів поспіль.

### 4) Зміни UX у хедері

- Замість dropdown-меню додано прямі кнопки дій у хедері (окремий коміт перед safe-mode доробками).
- Перемикач minimal mode тепер відображає заблокований стан на Xbox.

**Практичний ефект:** менше кліків для критичних дій, зрозуміліший стан режиму відтворення.

## Технічний вплив на код

- `apps/web/src/main.js`
  - централізує визначення режиму відтворення;
  - враховує URL-override для safe mode;
  - прокидає політики в `taskQueue` і `playbackController`.
- `apps/web/src/playback-controller.js`
  - отримав керовані прапорці для prefetch і batch prime;
  - поважає safe mode політики.
- `apps/web/src/task-queue.js`
  - додано керування output cache;
  - додано передачу `releaseAfter` у remux.
- `apps/web/src/ffmpeg-engine.js`
  - реалізовано скидання ffmpeg-стану та terminate після задачі.
- `README.md`
  - задокументовано minimal/safe mode, URL-override та memory behavior у safe mode.

## Ризики та сумісність

- **Позитивно:** стабільність на Xbox і слабких пристроях має зрости.
- **Компроміс:** у safe mode свідомо зменшено «агресивні» оптимізації (немає prefetch/HD-upgrade), тому найвища якість може з’являтися повільніше або не використовуватися.
- **Сумісність:** зміни зворотно сумісні для стандартного режиму; поведінка за замовчуванням на desktop-браузерах збережена.

## Рекомендований smoke-check після релізу

1. Desktop Chrome: перевірити standard flow (`480 -> max`) та автоперехід між епізодами.
2. Desktop + `?mode=minimal`: перевірити, що HD-upgrade не стартує.
3. Xbox Edge / `?xbox=1`: перевірити відсутність background tasks та стабільне послідовне відтворення 3+ епізодів.
4. Переконатися, що після перезавантаження сторінки режим коректно визначається (query > storage > default логіка).

## Короткий висновок

Останні зміни фокусуються на **операційній стабільності** (особливо Xbox), **контролі пам’яті ffmpeg.wasm** та **спрощенні UX керування режимами**. Це правильний напрям для frontend-only сценарію з важкою браузерною обробкою відео.
